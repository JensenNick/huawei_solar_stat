# ---------------------------------------------
# HUAWEI SOLAR STAT INPUT - User Specific Input
# ---------------------------------------------
# version: v1.0.0
# branch: main
# domain: https://github.com/JensenNick/huawei_solar_stat
# codeowner: Nick Jensen
#
# ------------
# INPUT NUMBER
# ------------
  ## ----------------
  ## Battery Capacity 
  # - October 2024 -
  # S0 = 30 kWh (2 ESS) per inverter
  # S1 + L1 wo EMMA = 10.5kWh (1 ESS) per inverter
  # S1 + L1 w EMMA = 21 kWh (2 ESS) w EMMA per inverter
  # S1 + M1/MAP0 = 21 kWh (2 ESS) per inverter
  # S1 + MB0 = 42 kWh (4 ESS) per inverter
  battery_rated_capacity_s0:
    name: "Battery Rated Capacity S0 (in kWh)"
    min: 5
    max: 30
    step: 5
  battery_rated_capacity_s1:
    name: "Battery Rated Capacity S1 (in kWh)"
    min: 7
    max: 42
    step: 7
  ## --------------------
  ## Battery Charge Power
  battery_charge_power_s0:
  # Charging power per inverter
    name: "Battery Charge Power S0 (in kW)"
    min: 0
    max: 5
    step: 0.1
  battery_charge_power_s1:
  # Charging power per inverter
    name: "Battery Charge Power S1 (in kW)"
    min: 0
    max: 10.5
    step: 0.1
input_number:
  ## ------------------
  ## Battery Efficiency
  battery_rated_capacity:
    name: "Battery Rated Capacity (in kWh)"
    min: 5
    max: 30
    step: 5
  battery_efficiency_soc_trigger:
    name: "Battery Efficiency SOC Trigger (Recomended Set 50%)"
    min: 0
    max: 100
    step: 5
  battery_efficiency_start_value_charge:
    name: "Battery Efficiency Start Value Charge (in kW)"
    min: 0
    max: 120000
    step: 0.01
    mode: box
  battery_efficiency_start_value_discharge:
    name: "Battery Efficiency Start Value Disharge (in kW)"
    min: 0
    max: 120000
    step: 0.01
    mode: box
  ## ------------
  ## Solar Panels
  panels_on_inverter_1:
    name: "Panels on Inverter #1"
    min: 0
    max: 50
    step: 1
    mode: box
  panels_on_inverter_2:
    name: "Panels on Inverter #2"
    min: 0
    max: 50
    step: 1
    mode: box
  panels_rated_wp:
    name: "Panels Rated Wp"
    min: 100
    max: 999
    step: 1
    mode: box

template:
  - sensor:
    - name: "Battery 1 Model"
      unique_id: battery_1_model
      state: >
        {% set device_model = device_attr('sensor.battery_1_state_of_capacity', 'model') %}
        {% if device_model == none %}
          Not Installed
        {% else %}
          {{ device_model }}
        {% endif %}
    - name: "Battery 2 Model"
      unique_id: battery_2_model
      state: >
        {% set device_model = device_attr('sensor.battery_2_state_of_capacity', 'model') %}
        {% if device_model == none %}
          Not Installed
        {% else %}
          {{ device_model }}
        {% endif %}
    - name: "Battery 3 Model"
      unique_id: battery_3_model
      state: >
        {% set device_model = device_attr('sensor.battery_3_state_of_capacity', 'model') %}
        {% if device_model == none %}
          Not Installed
        {% else %}
          {{ device_model }}
        {% endif %}
    - name: "Battery 4 Model"
      unique_id: battery_4_model
      state: >
        {% set device_model = device_attr('sensor.battery_4_state_of_capacity', 'model') %}
        {% if device_model == none %}
          Not Installed
        {% else %}
          {{ device_model }}
        {% endif %}
    - name: "Batteries Installed"
      unique_id: batteries_installed
      state: >
        {% set battery_sensors = [
          states('sensor.battery_1_model'),
          states('sensor.battery_2_model'),
          states('sensor.battery_3_model'),
          states('sensor.battery_4_model')
        ] %}
        {% set installed_batteries = battery_sensors | reject('in', ['unknown', 'unavailable', 'none', 'Not Installed']) | list %}
          {{ installed_batteries | count }}